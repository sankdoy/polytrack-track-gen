<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PolyTrack Image Trace Generator</title>
    <style>
      :root {
        --bg0: #f2f1eb;
        --bg1: #ddd8ca;
        --ink: #1e1e1e;
        --muted: #5c5b56;
        --panel: rgba(250, 248, 243, 0.88);
        --line: #c8c1af;
        --accent: #1f6db6;
        --accent2: #d24b1f;
        --good: #245f2a;
        --bad: #8e2723;
        --shadow: 0 14px 36px rgba(30, 30, 30, 0.12);
        --radius: 16px;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        font-family: "Sora", "Avenir Next", "Segoe UI", sans-serif;
        background:
          radial-gradient(circle at 8% 12%, rgba(31, 109, 182, 0.12), transparent 40%),
          radial-gradient(circle at 90% 10%, rgba(210, 75, 31, 0.11), transparent 42%),
          linear-gradient(165deg, var(--bg0), var(--bg1));
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 6;
        backdrop-filter: blur(8px);
        background: rgba(242, 241, 235, 0.72);
        border-bottom: 1px solid rgba(92, 91, 86, 0.12);
      }

      .topbar-inner {
        max-width: 1280px;
        margin: 0 auto;
        padding: 14px 18px;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
      }

      .title {
        display: flex;
        align-items: baseline;
        gap: 10px;
      }

      .title h1 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.03em;
      }

      .updated {
        margin: 0;
        color: var(--muted);
        font-size: 0.78rem;
      }

      main {
        max-width: 1280px;
        margin: 18px auto 40px;
        padding: 0 16px;
        display: grid;
        grid-template-columns: minmax(320px, 410px) minmax(0, 1fr);
        gap: 16px;
      }

      @media (max-width: 980px) {
        main {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
      }

      h2 {
        margin: 0 0 12px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
      }

      .field { margin-bottom: 12px; }

      label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.82rem;
        color: var(--muted);
        font-weight: 600;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
      }

      .split {
        display: grid;
        grid-template-columns: 1fr 110px;
        gap: 8px;
      }

      input[type="text"],
      input[type="number"],
      input[type="file"],
      select {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fdfcf8;
        color: var(--ink);
        padding: 9px 10px;
        font-size: 0.86rem;
      }

      input[type="range"] {
        width: 100%;
        accent-color: var(--accent);
      }

      .check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        color: var(--muted);
        font-size: 0.84rem;
      }

      .check input {
        width: 16px;
        height: 16px;
      }

      .btn {
        border: 1px solid rgba(30, 30, 30, 0.18);
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 700;
        font-size: 0.86rem;
        cursor: pointer;
        background: var(--accent);
        color: #fff;
      }

      .btn:hover { filter: brightness(1.06); }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #f6f3ea;
        color: var(--ink);
      }

      .status {
        margin-top: 10px;
        min-height: 1.2em;
        font-size: 0.82rem;
        color: var(--muted);
      }

      .status.good { color: var(--good); }
      .status.bad { color: var(--bad); }

      .value {
        font-weight: 700;
        color: var(--ink);
      }

      .preview-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }

      @media (max-width: 1200px) {
        .preview-grid {
          grid-template-columns: 1fr;
        }
      }

      .preview-card {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: #f8f5ee;
      }

      .preview-card h3 {
        margin: 0 0 8px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      canvas {
        width: 100%;
        max-width: 100%;
        border: 1px solid rgba(92, 91, 86, 0.34);
        border-radius: 10px;
        background: #faf9f5;
        image-rendering: crisp-edges;
      }

      #output {
        margin-top: 14px;
        display: none;
      }

      .result-card {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: #faf8f1;
        padding: 12px;
      }

      .result-head {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 8px;
        align-items: baseline;
      }

      .result-head h3 {
        margin: 0;
        font-size: 0.95rem;
      }

      .result-meta {
        font-size: 0.78rem;
        color: var(--muted);
      }

      .result-line {
        margin: 8px 0 0;
        font-size: 0.84rem;
      }

      .code {
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #f3efe4;
        padding: 10px;
        font-family: "SF Mono", "Cascadia Code", monospace;
        font-size: 0.78rem;
        line-height: 1.42;
        max-height: 110px;
        overflow: auto;
        word-break: break-all;
      }

      .actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
      }

      details {
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #f8f5ec;
      }

      summary {
        cursor: pointer;
        font-size: 0.82rem;
        padding: 8px 10px;
        color: var(--muted);
        font-weight: 700;
      }

      .diag {
        margin: 0;
        padding: 0 10px 10px;
        font-size: 0.74rem;
        line-height: 1.38;
        color: #3f3f3f;
        white-space: pre-wrap;
      }

      .hint {
        margin-top: 10px;
        font-size: 0.78rem;
        color: var(--muted);
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-inner">
        <div class="title">
          <h1>PolyTrack Image Trace Generator</h1>
          <p class="updated" id="updated"></p>
        </div>
      </div>
    </header>

    <main>
      <section class="panel" aria-label="Controls">
        <h2>Build Inputs</h2>

        <div class="field">
          <label for="imageInput">Track image</label>
          <input id="imageInput" type="file" accept="image/*" />
          <div id="imageStatus" class="status"></div>
        </div>

        <div class="field">
          <label for="name">Track name</label>
          <input id="name" type="text" value="Image Trace Track" />
        </div>

        <div class="field">
          <label for="environment">Environment</label>
          <select id="environment">
            <option value="Summer" selected>Summer</option>
            <option value="Winter">Winter</option>
            <option value="Desert">Desert</option>
            <option value="Default">Default</option>
          </select>
        </div>

        <div class="field split">
          <div>
            <label for="targetLength">Target length</label>
            <input id="targetLength" type="number" min="0.1" step="0.1" value="60" />
          </div>
          <div>
            <label for="lengthUnit">Unit</label>
            <select id="lengthUnit">
              <option value="km" selected>km</option>
              <option value="m">m</option>
              <option value="mi">miles</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="widthTiles">Track width (tiles)</label>
          <input id="widthTiles" type="number" min="3" max="12" step="1" value="3" />
        </div>

        <div class="field">
          <label for="scaleMode">Scaling mode</label>
          <select id="scaleMode">
            <option value="best-fit" selected>Best fit to target length</option>
            <option value="one-to-one">1:1 image pixels to tiles</option>
            <option value="manual">Manual scale ratio</option>
          </select>
        </div>

        <div class="field" id="scaleRatioWrap" style="display:none;">
          <label for="scaleRatio">Manual scale ratio (tiles / px)</label>
          <input id="scaleRatio" type="number" min="0.02" max="20" step="0.02" value="1" />
        </div>

        <div class="field">
          <label for="threshold">Black/white threshold <span class="value" id="thresholdVal">140</span></label>
          <input id="threshold" type="range" min="0" max="255" value="140" step="1" />
        </div>

        <label class="check"><input id="invert" type="checkbox" /> Detect light line on dark background (invert)</label>
        <label class="check"><input id="closeLoop" type="checkbox" checked /> Force closed loop</label>
        <label class="check"><input id="borderEnabled" type="checkbox" checked /> Add border pieces only outside road area</label>

        <div class="field">
          <label for="trimPasses">Endpoint trim passes (noise cleanup)</label>
          <input id="trimPasses" type="number" min="0" max="10" step="1" value="1" />
        </div>

        <button class="btn" id="generateBtn" type="button">Generate Track</button>
        <div class="status" id="status"></div>

        <p class="hint">
          The generator traces the line from your image, scales it to your target length, and builds a flat-piece track with border containment on the outside.
        </p>
      </section>

      <section class="panel" aria-label="Previews and output">
        <h2>Previews</h2>

        <div class="preview-grid">
          <article class="preview-card">
            <h3>Original</h3>
            <canvas id="previewOriginal" width="640" height="360"></canvas>
          </article>
          <article class="preview-card">
            <h3>Mask</h3>
            <canvas id="previewMask" width="640" height="360"></canvas>
          </article>
          <article class="preview-card">
            <h3>Trace</h3>
            <canvas id="previewTrace" width="640" height="360"></canvas>
          </article>
        </div>

        <section id="output" aria-label="Result output">
          <h2 style="margin-top:14px;">Share Code</h2>
          <div id="results"></div>
        </section>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script type="module" src="./app.mjs?v=2026-02-28d"></script>
  </body>
</html>
